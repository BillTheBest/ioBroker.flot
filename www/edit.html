<html>
<head>
    <title>Flot Edit</title>
    <link href="img/favicon.png" rel="shortcut icon" type="image/x-icon" />
    <link type="text/css" rel="stylesheet" href="/lib/css/themes/jquery-ui/default/jquery-ui.min.css">
    <link type="text/css" rel="stylesheet" href="/lib/css/fancytree/ui.fancytree.min.css"/>

    <script type="text/javascript" src="/lib/js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="/lib/js/jquery-ui-1.10.3.full.min.js"></script>
    <script type="text/javascript" src="/lib/js/jquery.fancytree-all.min.js"></script>
    <script type="text/javascript" src="/lib/js/translate.js"></script>
    <script type="text/javascript" src="/lib/js/selectID.js"></script>
    <script type="text/javascript" src="/lib/js/socket.io.js"></script>
    <script type="text/javascript" src="lib/js/jqColorPicker.min.js"></script>
    <script type="text/javascript" src="lib/js/jquery-deparam.js"></script>

    <script type="text/javascript" src="/_socket/info.js"></script>
    <script type="text/javascript" src="js/words.js"></script>

    <style>
        .input {
            /*width: 150px;*/
        }

        .input_time {
            width: 80px;
        }

        .label {
            width: 130px;
        }

        .ui-widget input {
            font-size: 14px;
        }

        .header {
            font-weight: bold;
            background: white;
            color: black;
        }

        body {
            font-family: Arial
        }

        h3 {
            line-height: 0.3!important;
            font-size: 15px!important;
        }

        .ui-accordion-content {
            padding: 5px 10px !important;
        }


    </style>
</head>
<body style="height: calc(100% - 16px)">

<div style="height: 250px; position: relative">
    <div id="accordion">
        <h3 id="0"><span class="translate">Input data</span><div style="float:right; font-weight: normal; color: #959595">Version: 1.0.0</div></h3>
        <div>
            <table>
                <tr>
                    <td colspan="7">
                        <button style="margin-left: 1px" id="ids_add" class="translateB">Add new line</button>
                        <button id="clear" title="Reset settings" class="translateT" style="float: left;">Clear</button>
                        <span class="translate" style="padding-left: 20px">Auto-update:</span><input type="checkbox" id="autoUpdate"/>
                        <button id="arrangeBools" class="translateB">Arrange bools</button>
                    </td>
                </tr>
                <tr>
                    <td colspan="7">
                        <table style="table-layout: fixed;" id="idslist" border="0" cellspacing="0" cellpadding="0"></table>
                    </td>
                </tr>
               <!-- <tr>
                 <td colspan="7">
					<span class="translate">Common Y Axis:</span><input type="checkbox" class="value" id="commonYAxis"/>
                 </td>
               </tr> -->
				
                <!--<tr>-->
                <!--<td class="translate label">same Day:</td>-->
                <!--<td><input type="checkbox" id="sameDay" class="value"></td>-->
                <!--</tr>-->
                <!--<tr>-->
                <!--<td class="translate label">same Month:</td>-->
                <!--<td><input type="checkbox" id="sameMonth" class="value"></td>-->
                <!--</tr>-->
                <!--<tr>-->
                <!--<td class="translate label">same Year:</td>-->
                <!--<td><input type="checkbox" id="sameYear" class="value"></td>-->
                <!--</tr>-->


            </table>
        </div>
        <h3 id="1"><span class="translate">Time</span> <span id="time_span"></span></h3>
        <div style="display: flex">
            <table >
                <tr>
                    <td class="translate header" colspan="2" style="text-align: center">Time Span</td>
                </tr>
                <tr>
                    <td class="translate">Art:</td>
                    <td><select id="timeArt" class="input value">
                        <option value="relative" class="translate">relative</option>
                        <option value="static"   class="translate">static</option>
                    </select></td>
                </tr>
                <tr class="relative">
                    <td class="translate">End:</td>
                    <td><select id="relativeEnd" class="input value">
                        <option value="now" class="translate">now</option>
                        <!--todo-->
                        <!--<option value="today" class="translate">today</option>-->
                        <!--<option value="month" class="translate">this month</option>-->
                        <!--<option value="year" class="translate">this year</option>-->
                    </select></td>
                </tr>
                <tr class="relative">
                    <td class="translate">Range:</td>
                    <td><select id="range"      class="value input">
                        <option value="10"      class="translate">10 Minutes</option>
                        <option value="30"      class="translate">30 Minutes</option>
                        <option value="60"      class="translate">1 Hour</option>
                        <option value="120"     class="translate">2 Hours</option>
                        <option value="180"     class="translate">3 Hours</option>
                        <option value="360"     class="translate">6 Hours</option>
                        <option value="720"     class="translate">12 Hours</option>
                        <option value="1440"    class="translate">1 Day</option>
                        <option value="2880"    class="translate">2 Days</option>
                        <option value="4320"    class="translate">3 Days</option>
                        <option value="10080"   class="translate">7 Days</option>
                        <option value="20160"   class="translate">14 Days</option>
                        <option value="43200"   class="translate">1 Month</option>
                        <option value="86400"   class="translate">2 Months</option>
                        <option value="129600"  class="translate">3 Months</option>
                        <option value="259200"  class="translate">6 Months</option>
                        <option value="525600"  class="translate">1 Year</option>
                        <option value="1051200" class="translate">2 Years</option>
                    </select></td>
                </tr>
                <tr class="relative">
                    <td class="translate">Live:</td>
                    <td><input type="checkbox" class="value" id="live"></td>
                </tr>

                <tr class="static">
                    <td class="translate">Start:</td>
                    <td><input type="date" id="start" class="value input"> <input type="time" id="start_time" class="value input_time"></td>
                </tr>
                <tr class="static">
                    <td class="translate">End:</td>
                    <td><input type="date" id="end" class="value input"> <input type="time" id="end_time" class="value input_time"></td>
                </tr>
            </table>
            <table style="margin-left: 25px">
                <tr>
                    <td class="translate header" colspan="2" style="text-align: center">Aggregate</td>
                </tr>
                <tr>
                    <td class="translate ">Step type:</td>
                    <td><select id="aggregateType" class="value input">
                        <option value="step" class="translate">seconds</option>
                        <option value="count" class="translate">counts</option>
                    </select></td>
                </tr>
                <tr>
                    <td class="translate" id="spanName">Step span:</td>
                    <td><input id="aggregateSpan" value="300" class="value input"></td>
                </tr>
                <!--tr>
                    <td class="translate label">ignore 'null':</td>
                    <td><input type="checkbox" id="ignoreNull" class="value"></td>
                </tr-->
            </table>
            <!--<table style="margin-left: 25px">-->
                <!--<tr>-->
                    <!--<td class="translate header" colspan="2" style="text-align: center">Navigation</td>-->
                <!--</tr>-->
                <!--<tr>-->
                    <!--<td class="translate ">on/off</td>-->
                    <!--<td><input id="nav" class="value" type="checkbox" /></td>-->
                <!--</tr>-->
                <!--&lt;!&ndash;todo&ndash;&gt;-->
                <!--&lt;!&ndash;<tr>&ndash;&gt;-->
                    <!--&lt;!&ndash;<td class="translate ">Show Zoom</td>&ndash;&gt;-->
                    <!--&lt;!&ndash;<td><input class="value" id="zoom" type="checkbox" />&ndash;&gt;-->
                   <!--&lt;!&ndash;</td>&ndash;&gt;-->
                <!--&lt;!&ndash;</tr>&ndash;&gt;-->
                <!--<tr>-->
                    <!--<td class="translate">Step Size:</td>-->
                    <!--<td>-->
                        <!--<input class="value" id="navStep" type="number" min="1" step="1" style="width: 80px"/>-->
                        <!--<select class="value input" id="navStepMulti" style="width: 100px">-->
                            <!--<option value=0 class="translate">seconds</option>-->
                            <!--<option value=60 class="translate">minutes</option>-->
                            <!--<option value=3600 class="translate">hours</option>-->
                            <!--<option value=86400 class="translate">days</option>-->
                            <!--<option value=604800 class="translate">weeks</option>-->
                            <!--<option value="M" class="translate">months</option>-->
                        <!--</select>-->
                    <!--</td>-->
                <!--</tr>-->
            <!--</table>-->
        </div>
        <h3 id="2" class="translate">Options</h3>
        <div style="display: flex">

            <table>
                <tr>
                    <td class="translate header" colspan="2" style="text-align: center">Appearance</td>
                <tr>
                    <td class="translate">Width:</td>
                    <td><input id="width" class="value input"></td>
                </tr>
                <tr>
                    <td class="translate">Height:</td>
                    <td><input id="height" class="value input"></td>
                </tr>
                <tr>
                    <td class="translate">No border:</td>
                    <td><select class="value input" id="noBorder">
                        <option value="" class="translate"></option>
                        <option value="noborder" class="translate">yes</option>
                    </select></td>
                </tr>
                <tr>
                    <td class="translate label">Window background:</td>
                    <td>
                        <input type="text" id="window_bg" class="value input">
                    </td>
                </tr>
                <tr>
                    <td class="translate label">Custom chart background:</td>
                    <td>
                        <input type="checkbox" id="bg_custom">
                    </td>
                </tr>
                <tr>
                    <td class="translate label">Chart background:</td>
                    <td>
                        <select id="bg_predefined">
                            <option value="" class="translate">default</option>
                            <option value="0">Portrait</option>
                            <option value="1">Instagram</option>
                            <option value="2">ServQuick</option>
                            <option value="3">Metallic Toad</option>
                            <option value="4">Clouds</option>
                            <option value="5">Mirage</option>
                            <option value="6">Steel Gray</option>
                            <option value="7">Horizon</option>
                            <option value="8">Koko Caramel</option>
                            <option value="9">Turquoise flow</option>
                        </select>
                        <input type="text" id="bg" class="value input" style="display: none">
                    </td>
                </tr>
                <tr>
                    <td class="translate label">X axis labels color:</td>
                    <td>
                        <input type="text" class="value input" id="x_labels_color">
                    </td>
                </tr>
                <tr>
                    <td class="translate label">Y axis labels color:</td>
                    <td>
                        <input type="text" class="value input" id="y_labels_color">
                    </td>
                </tr>

                </table>


            <table style="margin-left: 25px">
                <tr>
                    <td class="translate header" colspan="2" style="text-align: center">Title</td>
                </tr>
                <tr>
                    <td class="translate">Title:</td>
                    <td><input type="text" id="title" class="value input"></td>
                </tr>
                <!-- Do not use values 50, 5, and -5. They are reserved for 50-middle/center, 5-inside at edge, -5 outside at edge -->
                <tr>
                    <td class="translate">Title position:</td>
                    <td><select class="value input" id="titlePos">
                        <option value="" class="translate">none</option>
                        <option value="top:35;left:65" class="translate">Top, left, inside</option>
                        <option value="top:35;right:5" class="translate">Top, right, inside</option>
                        <option value="top:35;left:50" class="translate">Top, center, inside</option>
                        <option value="top:50;left:65" class="translate">Middle, left, inside</option>
                        <option value="top:50;right:5" class="translate">Middle, right, inside</option>
                        <option value="bottom:5;left:65" class="translate">Bottom, left, inside</option>
                        <option value="bottom:5;right:5" class="translate">Bottom, right, inside</option>
                        <option value="bottom:5;left:50" class="translate">Bottom, center, inside</option>

                        <option value="top:5;right:-5" class="translate">Top, right, outside</option>
                        <option value="top:50;right:-5" class="translate">Middle, right, outside</option>
                        <option value="bottom:5;right:-5" class="translate">Bottom, right, outside</option>
                        <option value="bottom:-5;left:50" class="translate">Bottom, center, outside</option>
                    </select></td>
                </tr>
                <tr>
                    <td class="translate">Title color:</td>
                    <td><input type="text" id="titleColor" class="value input"></td>
                </tr>
                <tr>
                    <td class="translate">Title size:</td>
                    <td><input type="text" id="titleSize" class="value input"></td>
                </tr>

            </table>

            <table style="margin-left: 25px">
                <td class="translate header" colspan="2" style="text-align: center">Options</td>
                <tr>
                    <td class="translate">Show legend:</td>
                    <td><select class="value input" id="legend">
                        <option value="" class="translate">none</option>
                        <option value="nw" class="translate">Top, left</option>
                        <option value="ne" class="translate">Top, right</option>
                        <option value="sw" class="translate">Bottom, left</option>
                        <option value="se" class="translate">Bottom, right</option>
                    </select></td>
                </tr>
                <tr>
                    <td class="translate">Hover details:</td>
                    <td><input type="checkbox" class="value" id="hoverDetail"></td>
                </tr>
                <tr>
                    <td class="translate">Time format:</td>
                    <td><select class="value input" id="timeFormat">
                        <option value="" class="translate">Default</option>
                        <option value="%H:%M %d.%m">HH:MM dd.mm</option>
                        <option value="%H:%M <br> %d.%m">HH:MM / dd.mm</option>
                        <option value="%H:%M:%S %d.%m.%y">HH:MM:SS dd.mm.yy</option>
                        <option value="%H:%M %d.%m.%y">HH:MM dd.mm.yy</option>
                        <option value="%I:%M:%S %x %p">HH:MM:SS mm/dd/yy am (US)</option>
                        <option value="%H:%M:%S %d/%m/%y">HH:MM:SS dd/mm/yy (UK)</option>
                        <option value="%H:%M:%S %m.%d.%y">HH:MM:SS mm.dd.yy</option>
                        <option value="%H:%M %m.%d">HH:MM mm.dd</option>
                        <option value="%H:%M:%S">HH:MM:SS</option>
                        <option value="%H:%M">HH:MM</option>
                        <option value="%d.%m.%y">dd.mm.yy</option>
                    </select></td>
                </tr>
                <tr>
                    <td class="translate">Smoothing:</td>
                    <td><input type="text" class="value input" id="smoothing"></td>
                </tr>
                <tr>
                    <td class="translate">After comma:</td>
                    <td><input type="text" class="value input" id="afterComma"></td>
                </tr>
                <tr>
                    <td class="translate">Use comma:</td>
                    <td><input type="checkbox" class="value" id="useComma"></td>
                </tr>
                <tr>
                    <td class="translate">Enable zoom and pan:</td>
                    <td><input type="checkbox" class="value" id="zoom"></td>
                </tr>
            </table>
        </div>
    </div>
</div>
<div style="display: flex;justify-content: space-around;align-items: center;margin-top: 10px;margin-bottom: 10px">
    <label class="translate" for="link">Link</label>
    <textarea id="link" style="width: calc(100% - 200px); height: 55px; word-break: break-all; resize: none"></textarea>
    <button style="padding-left:0" id="open" class="translateB">Open</button>
</div>
<button id="updatePreview" class="translateB" style="width:100%;margin-bottom: 10px">update Preview</button>
<iframe src="index.html" style="width: 100%; bottom: 0; height: calc(100% - 350px);border: 1px solid #afafaf; border-radius: 2px" id="chart"></iframe>
<div id="dialog-select-member" style="display:none"></div>
<script>
    "use strict";

    var defaultColors = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF', '#800000', '#008000', '#000080', '#808000', '#800080', '#008080'];
    var instances   = [];
    var timer       = null;
    var showTimer   = null;

    var setup       = {
        options: {
            l: []
        }
    };

    addLine();

    var path = location.href.split('?')[1];
    if (path) {
        setup.options = deparam(path || '');
        // for compatibility. Not used any more
        if (setup.options._ids) {
            var ids    = setup.options._ids    ? setup.options._ids.split(';')    : [];
            var colors = setup.options._colors ? setup.options._colors.split(';') : [];
            var names  = setup.options._names  ? setup.options._names.split(';')  : [];
            var units  = setup.options._units  ? setup.options._units.split(';')  : [];
            setup.options.l = [];
            for (var i = 0; i < ids.length; i++) {
                setup.options.l.push({
                    id:         ids[i],
                    offset:     0,
                    name:       names[i] || '',
                    art:        'average',
                    color:      colors[i] || 'blue',
                    thickness:  setup.options.strokeWidth || 1,
                    shadowsize: setup.options.strokeWidth || 1,
                    min:        setup.options.min || '',
                    max:        setup.options.max || '',
                    unit:       units[i]          || ''
                });
            }
            setup.options.range = parseInt(setup.options.range, 10);
            setup.options.aggregateType = 'step';
            setup.options.aggregateSpan = 300;
            setup.options.relativeEnd   = 'now';
            if (setup.options._colors)  delete setup.options._colors;
            if (setup.options._names)   delete setup.options._names;
            if (setup.options._ids)     delete setup.options._ids;
        }
        setup.options.l = setup.options.l || [];
    }

    if (typeof sysLang !== 'undefined') systemLang = sysLang || 'en';

    $('#dialog-select-member').selectId('init', {
        filter: {
            common: {
                history: {
                    enabled: true
                }
            }
        },
        noMultiselect: true,
        connCfg: {
            socketUrl:      socketUrl,
            socketSession:  socketSession,
            socketName:     'flotEdit'
        },
        columns: ['name', 'role', 'room', 'value'],
        texts: {
            select:     _('Select'),
            cancel:     _('Cancel'),
            all:        _('All'),
            id:         _('ID'),
            name:       _('Name'),
            role:       _('Role'),
            room:       _('Room'),
            value:      _('Value'),
            selectid:   _('Select ID'),
            from:       _('From'),
            lc:         _('Last changed'),
            ts:         _('Time stamp'),
            wait:       _('Processing...'),
            ack:        _('Acknowledged')
        }
    });

    function addLine() {
        if (!setup.options.l) setup.options.l = [];
        var index = setup.options.l.length;

        setup.options.l.push({
            id:         '',
            instance:   '',
            offset:     0,
            art:        'average',
            color:      defaultColors[index] || '#00FFFF',
            min:        '',
            max:        '',
            thickness:  3,
            shadowsize: 3,
            unit:       '',
            name:       ''
        });

        return index;
    }

    function showIds(callback) {
        setTimeout(function () {
            var text = '<tr style="text-align: center" class="header">' +
                    '<td></td>' +
                    '<td >' + _('ID') +  '</td>' +
                    '<td ></td>' +
                    '<td >' + _('Instance')      + '</td>' +
                    '<td >' + _('Offset')        + '</td>' +
                    '<td >' + _('Y-Offset')      + '</td>' +
                    '<td >' + _('Art')           + '</td>' +
                    '<td >' + _('Chart Type')    + '</td>' +
                    '<td >' + _('Color')         + '</td>' +
                    '<td >' + _( 'Min')          + '</td>' +
                    '<td >' + _('Max')           + '</td>' +
                    '<td >' + _('Unit')          + '</td>' +
                    '<td >' + _('Y Axis')        + '</td>' +
                    '<td >' + _('X Axis')        + '</td>' +
                    '<td title="' + _('Line Width')  + '">&#216L</td>' + // diameter
                    '<td title="' + _('Shadow Size') + '">&#216S</td>' + // ShadowSize
                    '<td >' + _('Name')          + '</td>' +
                    '<td >' + _('Common Y Axis') + '</td>' +
                    '<td >' + _('no null') + '</td>';

            var textInstances = '<option value="">' + _('default') + '</option>\n';
            for (var t = 0; t < instances.length; t++) {
                textInstances += '<option value="' + instances[t] + '">' + instances[t] + '</option>\n';
            }

            for (var i = 0; i < setup.options.l.length; i++) {
                var line = setup.options.l[i];

                text += '<tr id="inputData' + i + '" class="inputData">' +
                        '<td title="' + _('Line') + ' ' + (i + 1) + '">' + (i + 1) + '</td>' +
                        '<td style="padding-left: 4px; display:"><input  data-option="id"       data-index="' + i + '" class="input options-lines ids" style="display: inline; width: 200px; direction: rtl;" value="' + line.id + '"></td><td><button style="display: inline" class="select-dialog" data-ids="' + i + '">...</button></td>' +
                        '<td style="padding-left: 4px; display:"><select data-option="instance" data-index="' + i + '" class="input options-lines" style="display: inline; value="' + (line.instance || '') + '">' + textInstances + '</select></td>' +
                        '<td style="padding-left: 5px">' +
                        '<select class="input options-lines" style="width: 70px" data-index="' + i + '" data-option="offset"> ' +
                            '<option value="0">'        + _('0s')   + '</option> ' +
                            '<option value="10">'       + _('10s')  + '</option>' +
                            '<option value="30">'       + _('30s')  + '</option>' +
                            '<option value="60">'       + _('60s')  + '</option>' +
                            '<option value="120">'      + _('2m')   + '</option>' +
                            '<option value="180">'      + _('3m')   + '</option>' +
                            '<option value="240">'      + _('4m')   + '</option>' +
                            '<option value="300">'      + _('5m')   + '</option>' +
                            '<option value="600">'      + _('10m')  + '</option>' +
                            '<option value="900">'      + _('15m')  + '</option>' +
                            '<option value="1800">'     + _('30m')  + '</option>' +
                            '<option value="2700">'     + _('45m')  + '</option>' +
                            '<option value="3600">'     + _('1H')   + '</option>' +
                            '<option value="7200">'     + _('2H')   + '</option>' +
                            '<option value="21600">'    + _('6H')   + '</option>' +
                            '<option value="43200">'    + _('12H')  + '</option>' +
                            '<option value="86400">'    + _('1D')   + '</option>' +
                            '<option value="172800">'   + _('2D')   + '</option>' +
                            '<option value="259200">'   + _('3D')   + '</option>' +
                            '<option value="345600">'   + _('4D')   + '</option>' +
                            '<option value="604800">'   + _('1W')   + '</option>' +
                            '<option value="1209600">'  + _('2W')   + '</option>' +
                            '<option value="2419200">'  + _('4W')   + '</option>' +
                            '<option value="4838400">'  + _('8W')   + '</option>' +
                            '<option value="7257600">'  + _('12W')  + '</option>' +
                            '<option value="15724800">' + _('26W')  + '</option>' +
                            '<option value="30758400">' + _('1Y')   + '</option>' +
                            '<option value="61516800">' + _('2Y')   + '</option>' +
                        '</select></td>' +
                        '<td style="padding-left: 5px">' +
                        '<input data-option="yOffset" style="width: 70px" data-index="' + i + '" class="options-lines" value="' + (line.yOffset || '') + '">' +
                        '</td>' +
                        '<td style="padding-left:5px">' +
                        '<select style="width: 90px" data-option="art" class="input options-lines" data-index="' + i + '">' +
                            '<option value="average">'  + _('average')   + '</option>' +
                            '<option value="max">'      + _('max')       + '</option>' +
                            '<option value="min">'      + _('min')       + '</option>' +
                            '<option value="total">'    + _('total')     + '</option>' +
                            '<option value="onchange">' + _('on change') + '</option>' +
                        '</select>' +
                        '</td>' +
                        '<td><select style="width: 120px" data-option="chartType" class="input options-lines" data-index="' + i + '">'+
                            '<option value="line">'         + _('Line')         + '</option>' +
                            '<option value="area">'         + _('Area')         + '</option>' +
                            '<!--<option value="bar">'      + _('Bar')          + '</option>-->' +
                            '<option value="lineplot">'     + _('Line plot')    + '</option>' +
                            '<option value="scatterplot">'  + _('Scatter plot') + '</option>' +
                            '<option value="steps">'        + _('Steps')        + '</option>' +
                            '<!--<option value="pie">'      + _('Pie')          + '</option>-->' +
                        '</select></td>' +
                        '<td style="padding-left:5px"><input data-option="color" style="width: 70px" data-index="' + i + '" class="options-lines input-color" value="' + (line.color || '') + '"></td>' +
                        '<td style="padding-left:5px"><input data-option="min"   style="width: 70px" data-index="' + i + '" class="options-lines" value="' + ((line.min === undefined) ? '' : line.min) + '"></td>' +
                        '<td style="padding-left:5px"><input data-option="max"   style="width: 70px" data-index="' + i + '" class="options-lines" value="' + ((line.max === undefined) ? '' : line.max) + '"></td>' +
                        '<td style="padding-left:5px"><input data-option="unit"  style="width: 70px" data-index="' + i + '" class="options-lines" value="' + (line.unit || '') + '"></td>' +
                        '<td style="padding-left:5px">' +
                        '<select style="width:  140px" data-option="yaxe" class="input options-lines" data-index="' + i + '">' +
                            '<option value="">'             + _('default')       + '</option>' +
                            '<option value="off">'          + _('off')           + '</option>' +
                            '<option value="left">'         + _('left')          + '</option>' +
                            '<option value="right">'        + _('right')         + '</option>' +
                            '<option value="leftColor">'    + _('left colored')  + '</option>' +
                            '<option value="rightColor">'   + _('right colored') + '</option>' +
                        '</select></td>' +
                        '<td style="padding-left:5px">' +
                        '<select style="width:  140px" data-option="xaxe" class="input options-lines" data-index="' + i + '">' +
                            '<option value="">'             + _('default')          + '</option>' +
                            '<option value="off">'          + _('off')              + '</option>' +
                            '<option value="top">'          + _('top')              + '</option>' +
                            '<option value="bottom">'       + _('bottom')           + '</option>' +
                            '<option value="topColor">'     + _('top colored')      + '</option>' +
                            '<option value="bottomColor">'  + _('bottom colored')   + '</option>' +
                        '</select></td>' +
                        '<td style="padding-left:5px"><input data-option="thickness"  class="options-lines" data-index="' + i + '" style="width: 30px"   value="' + (line.thickness  || 1)  + '"></td>' +
                        '<td style="padding-left:5px"><input data-option="shadowsize" class="options-lines" data-index="' + i + '" style="width: 30px"   value="' + (line.shadowsize || 0)  + '"></td>' +
                        '<td style="padding-left:5px"><input data-option="name"       class="options-lines" data-index="' + i + '" style="width: 200px"  value="' + (line.name       || '') + '"></td>' +
                        '<td style="text-align: center; padding-left:5px">' +
                        '<select data-option="commonYAxis" class="input options-lines" data-index="' + i + '">' +
                            '<option value="">'     + _('default')  + '</option>' +
                            '<option value="1">'    + '1'           + '</option>' +
                            '<option value="2">'    + '2'           + '</option>' +
                            '<option value="3">'    + '3'           + '</option>' +
                            '<option value="4">'    + '4'           + '</option>' +
                            '<option value="5">'    + '5'           + '</option>' +
                        '</select></td>' +
                        '<td style="text-align: center"><input data-option="ignoreNull" class="options-lines" data-index="' + i + '" type="checkbox" ' + (line.ignoreNull ? 'checked' : '') + '></td>' +

                        '<td style="padding-left:5px"><button class="id-remove" data-index="' + i + '"></button></td>' +

                        '</tr>';
            }

            $('#idslist').html(text);

            $('.input-color').colorPicker({
                renderCallback: function ($elm, toggled) {
                    if (toggled === false) {
                        $elm.trigger('change');
                    }
                }
            });

            $('.id-remove').button({
                icons: {primary: 'ui-icon-trash'},
                text: false
            }).click(function () {
                if (setup.options.l.length) {
                    var i = parseInt($(this).parent().parent().attr('id').replace('inputData', ''));
                    setup.options.l.splice(i, 1);
                    if (!setup.options.l.length) {
                        addLine();
                    }
                    showIds();
                    save();
                    delayedUpdate();
                }
            }).css({width: 22, height: 22});

            $('.select-dialog').button({
                text: false,
                icons: {
                    primary: 'ui-icon-folder-open'
                }
            }).css({width: 25, height: 22}).click(function () {
                var index = $(this).parent().parent().attr('id').replace('inputData', '');
                $('#dialog-select-member').selectId('show', setup.options.l[index].id, undefined, function (newId, ignore, obj) {
                    setup.options.l[index].id = newId;
                    $('.ids[data-index="' + index + '"]').val(newId).trigger('change');
                    if (obj && obj.common.type === 'boolean') {
                        $('select[data-option="art"][data-index="' + index + '"]').val('onchange').trigger('change');
                        $('select[data-option="chartType"][data-index="' + index + '"]').val('steps').trigger('change');
                        $('input[data-option="min"][data-index="' + index + '"]').val(0).trigger('change');
                        $('input[data-option="max"][data-index="' + index + '"]').val(10).trigger('change');
                    }
                    showIds();
                });
            });

            $('.options-lines').each(function () {
                var $this = $(this);
                var index = $(this).parent().parent().attr('id').replace('inputData', '');
                var opt   = $(this).data('option');

                if (setup.options.l[index][opt] !== undefined) {
                    if ($this.attr('type') == 'checkbox') {
                        $this.prop('checked', !!setup.options.l[index][opt]);
                    } else {
                        $this.val(setup.options.l[index][opt]);
                    }
                }
            });

            if (typeof callback == 'function') callback();
        }, 100);
    }

    function getSettings() {
        var _options = JSON.parse(JSON.stringify(setup.options));

        // clean options
        for (var y in _options){
            if (_options[y] === ''){
                delete _options[y];
            }
        }

        // clean lines
        for (var i = 0; i < _options.l.length; i++) {
            if (_options.l[i].id === ''){
                _options.l.splice(i, 1);
                i--;
            } else {
                for (var x in _options.l[i]) {
                    if (_options.l[i][x] === '') {
                        delete _options.l[i][x];
                    }
                }
            }
        }

        var params = $.param(_options);

        //console.log(deparam(params));

        return params;
    }

    function delayedUpdate() {
        if (timer) clearTimeout(timer);
        timer = setTimeout(update, 500);
    }

    function update() {
        clearTimeout(timer);
        timer = null;

        // Store settings
        if (typeof(Storage) !== 'undefined') {
            $('.value').each(function () {
                if ($(this).attr('type') == 'checkbox') {
                    setup.options[$(this).attr('id')] = $(this).prop('checked');
                } else {
                    setup.options[$(this).attr('id')] = $(this).val();
                }
            });

            save();
        }
        var settings = getSettings();
        $('#link').val(location.href.split('?')[0].replace('edit.html', 'index.html') + '?' + settings);
        $('#updatePreview').button('option', 'disabled', false).click(updatePreview);

        if ($('#aggregateType').val() === 'step') {
            $('#spanName').text(_('Seconds') + ':');
        } else {
            $('#spanName').text(_('Counts') + ':');
        }
        $('.relative, .static').hide();
        $('.' + $('#timeArt').val()).show();

        if ($('#autoUpdate').prop('checked')) {
            delayedPreview();
            $('#updatePreview').hide();
        }

        // calculate span
        var text = '';
        if (setup.options.timeArt === 'relative') {
            text =  _('%s ago', $('#range option:selected').text()) + ' - ' + _(setup.options.relativeEnd);
        } else {
            text = new Date(setup.options.start).toLocaleDateString() + ' ' +
                   new Date(setup.options.start + ' ' + setup.options.start_time).toLocaleTimeString() + ' - ' +
                   new Date(setup.options.end).toLocaleDateString() + ' ' +
                   new Date(setup.options.end + ' ' + setup.options.end_time).toLocaleTimeString();
        }
        $('#time_span').html('[' + text + ']');
    }

    function save() {
        if (typeof(Storage) !== 'undefined') {
            localStorage.setItem('iobroker.Flot', JSON.stringify(setup));
       }
    }

    function delayedPreview() {
        if (showTimer) clearTimeout(showTimer);
        showTimer = setTimeout(updatePreview, 500);
    }

    function updatePreview() {
        if (parseInt($('#height').val())) {
            $('#chart').css({height: (parseInt($('#height').val()) || 500) + 90});
        } else {
            $('#chart').css({height: 'calc(100% - 350px)'});
        }

        var settings = getSettings();
        $('#chart').attr('src', '');
        setTimeout(function () {
            $('#chart').attr('src', 'index.html?' + settings + '&' + (new Date()).getTime());
        }, 0);

//        $('#updatePreview').button("option", "disabled", true);
    }

    $(document).ready(function() {
        if (typeof(Storage) !== 'undefined') {
            var _setup = localStorage.getItem('iobroker.Flot');
            if (_setup) {
                try {
                    _setup = JSON.parse(_setup);
                    if (path) {
                        _setup.options = setup.options;
                        setup = _setup;
                        save();
                        document.location.href = document.location.href.split('?')[0];
                    } else if (_setup.options) {
                        setup = _setup;
                    }
                }
                catch (e) {
                    console.log('Cannot parse stored settings');
                }
            }
        }

        if (setup.options.lines) {
            setup.options.l = JSON.parse(JSON.stringify(setup.options.lines));
            delete setup.options.lines;
        }

        if (!setup.options.l || !setup.options.l.length) addLine();

        $('#autoUpdate').change(function () {
            setup['auto-update'] = $(this).prop('checked') ? 'true' : 'false';
            update();
            if (setup['auto-update'] == 'true') {
                $('#updatePreview').hide();
            } else {
                $('#updatePreview').show();
            }
        }).prop('checked', setup['auto-update'] == 'true');

        $('#arrangeBools').button().click(function () {
            // arrange all boolean values automatically
            //  calculate
            var count = 0;
            var axis = null;
            for (var i = 0; i < setup.options.l.length; i++) {
                if (setup.options.l[i].chartType == 'steps') {
                    if (axis === null) axis = i;
                    count++;
                }
            }

            var t = 0;
            for (var i = 0; i < setup.options.l.length; i++) {
                if (setup.options.l[i].chartType == 'steps') {
                    setup.options.l[i].max = Math.round(count * 2 * 1.2 * 10) / 10;
                    setup.options.l[i].commonYAxis = axis + 1;
                    setup.options.l[i].yOffset = Math.round(-(t + 1) * 1.2 * 10) / 10;
                    setup.options.l[i].min  = Math.round((-count * 1.2 - 0.1) * 10) / 10;
                    setup.options.l[i].yaxe = 'off';
                    t++;
                }
                setup.options.l[i].min  = Math.round((-count * 1.2 - 0.1) * 10) / 10;
            }
            showIds();
            save();
            delayedUpdate();
        });

        $('#accordion').on('change', '.options-lines', function () {
            var index = parseInt($(this).parent().parent().attr('id').replace('inputData', ''));
            if ($(this).attr('type') === 'checkbox') {
                setup.options.l[index][$(this).data('option')] = $(this).prop('checked');
            } else {
                setup.options.l[index][$(this).data('option')] = $(this).val();
            }
            update();
        });

        $('#accordion').on('keyup', '.options-lines', function () {
            $(this).trigger('change');
        });

        $('.value').each(function () {
            var $this = $(this);
            var id = $this.attr('id');
            if (setup.options[id] !== undefined) {
                if ($this.attr('type') == 'checkbox') {
                    $this.prop('checked', !!setup.options[id]);
                } else {
                    $this.val(setup.options[id]);
                }
            }
        });

        $('#ids_add').button({
            icons: {secondary: 'ui-icon-plus'},
            text: true
        }).click(function () {
            addLine();
            showIds();
        }).css({height: 30});

        $('#clear').button({
            icons: {primary: 'ui-icon-trash'},
            text: false
        }).click(function () {
            localStorage.setItem('iobroker.Flot', JSON.stringify({reset: true}));
            location.reload();
        }).css({width: 30, height: 30});

        $('.value').change(update).keyup(function () {
            $(this).trigger('change');
        });

        $('#timeArt').change(function () {
            $('.relative, .static').hide();
            $('.' + $(this).val()).show();
        });

        $('#width').spinner().on('spin', delayedUpdate).parent().addClass('input');
        $('#height').spinner().on('spin', delayedUpdate).parent().addClass('input');
        $('#smoothing').spinner().on('spin', delayedUpdate).parent().addClass('input');
        $('#strokeWidth').spinner().on('spin', delayedUpdate).parent().addClass('input');
        $('#afterComma').spinner().on('spin', delayedUpdate).parent().addClass('input');

        $('#bg_custom').change(function () {
            if ($(this).prop('checked')) {
                $('#bg').show();
                $('#bg_predefined').hide();
            } else {
                $('#bg').hide();
                $('#bg_predefined').show();
                $('#bg_predefined').val(0).trigger('change');
            }
        });

        $('#bg_predefined').change(function () {
            $('#bg').val($(this).val()).trigger('change');
        });

        if (setup.options.bg || setup.options.bg === 0) {
            if (setup.options.bg && setup.options.bg.length < 3 && parseInt(setup.options.bg, 10).toString() == setup.options.bg) {
                $('#bg').hide();
                $('#bg_predefined').show().val(setup.options.bg);
            } else {
                $('#bg_custom').prop('checked', true);
                $('#bg').show();
                $('#bg_predefined').hide();
            }
        }

        $('#aggregateType').change(function () {
            if ($('#aggregateType').val() == 'step') {
                $('#spanName').text(_('Seconds'));
            } else {
                $('#spanName').text(_('Counts'));
            }
        });

//      $('#range').val(options.range);
//      $('#axeX').val(options.axeX);
        $('#updatePreview').button({
            icons: {
                primary: 'ui-icon-refresh'
            }
        });
        $('#open').button({
            icons: {
                primary: 'ui-icon-play'
            }
        }).click(function () {
            window.open($('#link').val(), 'flot');
        });

        translateAll();

        $('#accordion').accordion({
            active : parseInt(setup.acc) || 0,
            heightStyle: 'fill',
            animate: {
                easing: 'linear',
                duration: 200
            },
            activate: function (event, ui) {
                setup['acc'] = $(ui.newHeader).attr('id');
                save();
            }
        });

        // Read instances
        var socket = io.connect(socketUrl, {
            'query':                        'key=' + socketSession,
            'reconnection limit':           10000,
            'max reconnection attempts':    Infinity
        });

        socket.on('connect', function () {
            this.emit('name', 'flotEdit');
            // load history instances
            socket.emit('getObjectView', 'system', 'instance', {startkey: 'system.adapter.', endkey: 'system.adapter.\u9999'}, function (err, doc) {
                if (!err && doc && doc.rows) {
                    if (doc.rows.length === 0) {
                        if (callback) callback ([]);
                    } else {
                        var res = [];
                        for (var i = 0; i < doc.rows.length; i++) {
                            var obj = doc.rows[i].value;
                            if (obj && obj.type === 'instance' && obj.common && obj.common.type === 'storage') {
                                instances.push(obj._id.substring('system.adapter.'.length));
                            }
                        }
                    }
                }
                showIds();

                update();

                // not need to disconnect, because socket-io uses pool
                //socket.disconnect();
                //socket = null;
            });
        });

        // Handler for .ready() called.
    });

</script>
</body>
</html>
