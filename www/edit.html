<html>
<head>
    <link type="text/css" rel="stylesheet" href="/lib/css/themes/jquery-ui/redmond/jquery-ui.min.css">
    <link type="text/css" rel="stylesheet" href="/lib/css/fancytree/ui.fancytree.min.css"/>


    <script type="text/javascript" src="/lib/js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="/lib/js/jquery-ui-1.10.3.full.min.js"></script>
    <script type="text/javascript" src="/lib/js/jquery.fancytree-all.min.js"></script>
    <script type="text/javascript" src="/lib/js/translate.js"></script>
    <script type="text/javascript" src="/lib/js/selectID.js"></script>
    <script type="text/javascript" src="/lib/js/socket.io.js"></script>
    <script type="text/javascript" src="lib/js/jqColorPicker.min.js"></script>
    <script type="text/javascript" src="lib/js/jquery-deparam.js"></script>

    <script type="text/javascript" src="/_socket/info.js"></script>
    <script type="text/javascript" src="js/words.js"></script>
    <!--this file must be after translate.js -->

    <style>
        .input {
            width: 150px;
        }

        .label {
            width: 130px;
        }

        .ui-widget input {
            font-size: 14px;
        }

        .header {
            font-weight: bold;
            background: rgba(150, 150, 255, 0.100);
        }

        body {
            font-family: Arial
        }

        h3 {
            line-height: 0.3!important;
            font-size: 15px!important;
        }

        .ui-accordion-content {
            padding: 5px 10px !important;
        }


    </style>
</head>
<body style="height: calc(100% - 16px)">

<div style="height: 250px; position: relative">
    <div id="accordion">
        <h3 id="0" class="translate">Input data</h3>
        <div>
            <table>
                <tr>
                    <td colspan="2">
                        <button style="margin-left: 1px" id="ids_add" class="translateB">Add new line</button>
                        <button id="clear" title="Reset settings" class="translateT" style="float: left;">Clear</button>
                    </td>
                    <td>
                    </td>

                </tr>
                <tr>
                    <td colspan="7">
                        <table style="table-layout: fixed;" id="idslist" border="0" cellspacing="0" cellpadding="0"></table>
                    </td>
                </tr>

                <!--<tr>-->
                <!--<td class="translate label">same Day:</td>-->
                <!--<td><input type="checkbox" id="sameDay" class="value input"></td>-->
                <!--</tr>-->
                <!--<tr>-->
                <!--<td class="translate label">same Month:</td>-->
                <!--<td><input type="checkbox" id="sameMonth" class="value input"></td>-->
                <!--</tr>-->
                <!--<tr>-->
                <!--<td class="translate label">same Year:</td>-->
                <!--<td><input type="checkbox" id="sameYear" class="value input"></td>-->
                <!--</tr>-->


            </table>
        </div>
        <h3 id="1" class="translate">Time</h3>
        <div style="display: flex">
            <table >
                <tr>
                    <td class="translate header" colspan="2" style="text-align: center">Time Span</td>
                </tr>
                <tr>
                    <td class="translate">Art:</td>
                    <td><select id="timeArt" class="input option">
                        <option value="relative" class="translate">relative</option>
                        <option value="static" class="translate">static</option>
                    </select></td>
                </tr>
                <tr class="relative">
                    <td class="translate">End:</td>
                    <td><select id="relativeEnd" class="input option">
                        <option value="now" class="translate">now</option>
                        <option value="today" class="translate">today</option>
                        <option value="month" class="translate">this month</option>
                        <option value="year" class="translate">this year</option>
                    </select></td>
                </tr>
                <tr class="relative">
                    <td class="translate">Range:</td>
                    <td><select id="range" class="option input">
                        <option value="10" class="translate">10 Minutes</option>
                        <option value="30" class="translate">30 Minutes</option>
                        <option value="60" class="translate">1 Hour</option>
                        <option value="120" class="translate">2 Hours</option>
                        <option value="180" class="translate">3 Hours</option>
                        <option value="360" class="translate">6 Hours</option>
                        <option value="720" class="translate">12 Hours</option>
                        <option value="1440" class="translate">1 Day</option>
                        <option value="2880" class="translate">2 Days</option>
                        <option value="4320" class="translate">3 Days</option>
                        <option value="10080" class="translate">7 Days</option>
                        <option value="20160" class="translate">14 Days</option>
                        <option value="43200" class="translate">1 Month</option>
                        <option value="86400" class="translate">2 Months</option>
                        <option value="129600" class="translate">3 Months</option>
                        <option value="259200" class="translate">6 Months</option>
                        <option value="525600" class="translate">1 Year</option>
                        <option value="1051200" class="translate">2 Years</option>
                    </select></td>
                </tr>
                <tr class="relative">
                    <td class="translate">Live:</td>
                    <td><input type="checkbox" class="option" id="live"></td>
                </tr>

                <tr class="static">
                    <td class="translate">Start:</td>
                    <td><input type="date" id="start" class="option input"></td>
                </tr>
                <tr class="static">
                    <td class="translate">End:</td>
                    <td><input type="date" id="end" class="option input"></td>
                </tr>
            </table>
            <table style="margin-left: 25px">
                <tr>
                    <td class="translate header" colspan="2" style="text-align: center">Aggregate</td>
                </tr>
                <tr>
                    <td class="translate ">Step type:</td>
                    <td><select id="aggregateType" class="option input">
                        <option value="step" class="translate">seconds</option>
                        <option value="count" class="translate">counts</option>
                    </select></td>
                </tr>
                <tr>
                    <td class="translate" id="spanName">Step span:</td>
                    <td><input id="aggregateSpan" value="300" class="option input"></td>
                </tr>
                <tr>
                    <td class="translate label">ignore 'null':</td>
                    <td><input type="checkbox" id="getNull" class="option input"></td>
                </tr>
            </table>
        </div>
        <h3 id="2" class="translate">Options</h3>
        <div style="display: flex">

                <table>
                    <tr>
                        <td class="translate header" colspan="2" style="text-align: center">Appearance</td>
                    <tr>
                        <td class="translate">Width:</td>
                        <td><input id="width" class="option input"></td>
                    </tr>
                    <tr>
                        <td class="translate">Height:</td>
                        <td><input id="height" class="option input"></td>
                    </tr>
                    <tr>
                        <td class="translate">No border:</td>
                        <td><select class="option input" id="noBorder">
                            <option value="" class="translate"></option>
                            <option value="noborder" class="translate">yes</option>
                        </select></td>
                    </tr>
                    <!--<tr>-->
                        <!--<td class="translate label">Predefined background:</td>-->
                        <!--<td><select class="input" id="pre_bg">-->
                            <!--<option value="" class="translate">User defined</option>-->
                            <!--<option value="0">Portrait</option>-->
                            <!--<option value="1">Instagram</option>-->
                            <!--<option value="2">ServQuick</option>-->
                            <!--<option value="3">Metallic Toad</option>-->
                            <!--<option value="4">Clouds</option>-->
                            <!--<option value="5">Mirage</option>-->
                            <!--<option value="6">Steel Gray</option>-->
                            <!--<option value="7">Horizon</option>-->
                            <!--<option value="8">Koko Caramel</option>-->
                            <!--<option value="9">Turquoise flow</option>-->
                        <!--</select></td>-->
                    <!--</tr>-->
                    <tr>
                        <td class="translate label">Background:</td>
                        <td><input type="text" id="bg" class="option input"></td>
                    </tr>
                    </table>


                <table style="margin-left: 25px">
                    <tr>
                        <td class="translate header" colspan="2" style="text-align: center">Title</td>
                    </tr>
                    <tr>
                        <td class="translate">Title:</td>
                        <td><input type="text" id="title" class="option input"></td>
                    </tr>
                    <!-- Do not use values 50, 5, and -5. They are reserved for 50-middle/center, 5-inside at edge, -5 outside at edge -->
                    <tr>
                        <td class="translate">Title position:</td>
                        <td><select class="option input" id="titlePos">
                            <option value="" class="translate">none</option>
                            <option value="top:35;left:65" class="translate">Top, left, inside</option>
                            <option value="top:35;right:5" class="translate">Top, right, inside</option>
                            <option value="top:35;left:50" class="translate">Top, center, inside</option>
                            <option value="top:50;left:65" class="translate">Middle, left, inside</option>
                            <option value="top:50;right:5" class="translate">Middle, right, inside</option>
                            <option value="bottom:5;left:65" class="translate">Bottom, left, inside</option>
                            <option value="bottom:5;right:5" class="translate">Bottom, right, inside</option>
                            <option value="bottom:5;left:50" class="translate">Bottom, center, inside</option>

                            <option value="top:5;right:-5" class="translate">Top, right, outside</option>
                            <option value="top:50;right:-5" class="translate">Middle, right, outside</option>
                            <option value="bottom:5;right:-5" class="translate">Bottom, right, outside</option>
                            <option value="bottom:-5;left:50" class="translate">Bottom, center, outside</option>
                        </select></td>
                    </tr>
                    <tr>
                        <td class="translate">Title color:</td>
                        <td><input type="text" id="titleColor" class="option input"></td>
                    </tr>
                    <tr>
                        <td class="translate">Title size:</td>
                        <td><input type="text" id="titleSize" class="option input"></td>
                    </tr>

                </table>

                <table style="margin-left: 25px">
                    <td class="translate header" colspan="2" style="text-align: center">Options</td>
                    <tr>
                        <td class="translate">Show legend:</td>
                        <td><select class="option input" id="legend">
                            <option value="" class="translate">none</option>
                            <option value="nw" class="translate">Top, left</option>
                            <option value="ne" class="translate">Top, right</option>
                            <option value="sw" class="translate">Bottom, left</option>
                            <option value="se" class="translate">Bottom, right</option>
                        </select></td>
                    </tr>
                    <tr>
                        <td class="translate">Hover details:</td>
                        <td><input type="checkbox" class="option" id="hoverDetail"></td>
                    </tr>
                    <tr>
                        <td class="translate">Time format:</td>
                        <td><select class="option input" id="timeFormat">
                            <option value="" class="translate">Default</option>
                            <option value="%H.%M %d.%m">HH:MM dd.mm</option>
                            <option value="%H.%M <br> %d.%m">HH:MM / dd.mm</option>
                            <option value="%H:%M:%S %d.%m.%y">HH:MM:SS dd.mm.yy</option>
                            <option value="%H:%M %d.%m.%y">HH:MM dd.mm.yy</option>
                            <option value="%I:%M:%S %x %p">HH:MM:SS mm/dd/yy am (US)</option>
                            <option value="%H:%M:%S %d/%m/%y">HH:MM:SS dd/mm/yy (UK)</option>
                            <option value="%H:%M:%S %m.%d.%y">HH:MM:SS mm.dd.yy</option>
                            <option value="%H:%M %m.%d">HH:MM mm.dd</option>
                            <option value="%H:%M:%S">HH:MM:SS</option>
                            <option value="%H:%M">HH:MM</option>
                            <option value="%d.%m.%y">dd.mm.yy</option>
                        </select></td>
                    </tr>
                    <tr>
                        <td class="translate">Smoothing:</td>
                        <td><input type="text" class="option input" id="smoothing"></td>
                    </tr>
                    <tr>
                        <td class="translate">After comma:</td>
                        <td><input type="text" class="option input" id="afterComma"></td>
                    </tr>
                </table>
        </div>
    </div>
</div>
<div style="display: flex;justify-content: space-around;align-items: center;margin-top: 10px;margin-bottom: 10px">
    <label class="translate" for="link">Link</label>
    <textarea id="link" style="width: calc(100% - 130px); height: 55px; word-break: break-all"></textarea>
    <button style="padding-left:0" id="open" class="translateB">Open</button>
</div>
<button id="updatePreview" class="translateB" onclick="updatePreview()" style="width:100%;margin-bottom: 10px">update Preview</button>
<iframe src="index.html" style="width: 100%; bottom: 0; height: calc(100% - 450px)" id="chart"></iframe>
<div id="dialog-select-member" style="display:none"></div>
<script>
    "use strict";

    var defaultColors = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF', '#800000', '#008000', '#000080', '#808000', '#800080', '#008080'];

    var objects = {};
    var states  = {};
    var timer   = null;

    var setup   = {
        options: {
            lines: [
                {
                    id:     '',
                    offset: 0,
                    art:    'average',
                    color:  '#FF0000',
                    min:    '',
                    max:    '',
                    thickness: 3,
                    unit:   '',
                    name:   ''
                }
            ]
        }
    };


    if (typeof sysLang !== 'undefined') systemLang = sysLang || 'en';

    $('#dialog-select-member').selectId('init', {
        filter: {
            common: {
                history: {
                    enabled: true
                }
            }
        },
        noMultiselect: true,
        connCfg: {
            socketUrl: socketUrl,
            socketSession: socketSession,
            socketName: 'rickshawEdit'
        },
        columns: ['name', 'role', 'room', 'value'],
        texts: {
            select:     _('Select'),
            cancel:     _('Cancel'),
            all:        _('All'),
            id:         _('ID'),
            name:       _('Name'),
            role:       _('Role'),
            room:       _('Room'),
            value:      _('Value'),
            selectid:   _('Select ID'),
            from:       _('From'),
            lc:         _('Last changed'),
            ts:         _('Time stamp'),
            wait:       _('Processing...'),
            ack:        _('Acknowledged')
        }
    });

    function showIds(callback) {
        setTimeout(function () {
            var text = '<tr style="text-align: center">' +
                    '<td></td>' +
                    '<td >'+_('ID')+'</td>' +
                    '<td ></td>' +
                    '<td >'+_('Offset')+'</td>' +
                    '<td >'+_('Art')+'</td>' +
                    '<td >'+_('Chart Type')+'</td>' +
                    '<td >'+_('Color')+'</td>' +
                    '<td >'+_('Min')+'</td>' +
                    '<td >'+_('Max')+'</td>' +
                    '<td >'+_('Unit')+'</td>' +
                    '<td >'+_('Y Axis')+'</td>' +
                    '<td >'+_('X Axis')+'</td>' +
                    '<td >&#216</td>' +
                    '<td >'+_('Name')+'</td></tr>';

            for (var i= 0; i < setup.options.lines.length; i++) {
                var index = setup.options.lines[i]

                text += '<tr id="inputData' + i + '" class="inputData">' +
                        '<td class="label" style="width: 60px; min-width: 60px">' + _('Line') + ' ' + (i + 1) + '</td>' +
                        '<td style="padding-left: 4px; display:"><input data-option="id" class="input inputData_id idsnames options_lines" style="display: inline; width: 200px" value="' + index.id + '"></td><td><button style="display: inline" class="select-dialog" data-ids="' + i + '">...</button></td>' +
                        '<td style="padding-left:5px">' +
                        '<select class="input inputData_offset options_lines" style="width: 70px"  data-option="offset"> ' +
                            '<option value="0">' + _("0s") + '</option> ' +
                            '<option value="10">' + _("10s") + '</option>' +
                            '<option value="30">' + _("30s") + '</option>' +
                            '<option value="60">' + _("60s") + '</option>' +
                            '<option value="120">' + _("2m") + '</option>' +
                            '<option value="180">' + _("3m") + '</option>' +
                            '<option value="240">' + _("4m") + '</option>' +
                            '<option value="300">' + _("5m") + '</option>' +
                            '<option value="600">' + _("10m") + '</option>' +
                            '<option value="900">' + _("15m") + '</option>' +
                            '<option value="1800">' + _("30m") + '</option>' +
                            '<option value="2700">' + _("45m") + '</option>' +
                            '<option value="3600">' + _("1H") + '</option>' +
                            '<option value="7200">' + _("2H") + '</option>' +
                            '<option value="21600">' + _("6H") + '</option>' +
                            '<option value="43200">' + _("12H") + '</option>' +
                            '<option value="86400">' + _("1D") + '</option>' +
                            '<option value="172800">' + _("2D") + '</option>' +
                            '<option value="259200">' + _("3D") + '</option>' +
                            '<option value="345600">' + _("4D") + '</option>' +
                            '<option value="604800">' + _("1W") + '</option>' +
                            '<option value="1209600">' + _("2W") + '</option>' +
                            '<option value="2419200">' + _("4W") + '</option>' +
                            '<option value="30758400">' + _("1Y") + '</option>' +
                            '<option value="61516800">' + _("2Y") + '</option>' +
                        '</select></td>' +
                        '<td style="padding-left:5px">' +
                        '<select style="width: 90px" data-option="art" class="input inputData_art options_lines">' +
                            '<option value="average">' + _("average") + '</option>' +
                            '<option value="max">' + _("max") + '</option>' +
                            '<option value="min">' + _("min") + '</option>' +
                            '<option value="total">' + _("total") + '</option>' +
                        '</select>' +
                        '</td>' +
                        '<td><select style="width: 120px" data-option="chartType" class="input options_lines">'+
                            '<option value="line">' + _("Line") + '</option>'+
                            '<option value="area">' + _("Area") + '</option>'+
                            '<!--<option value="bar">' + _("Bar") + '</option>-->'+
                            '<option value="lineplot">' + _("Line plot") + '</option>'+
                            '<option value="scatterplot">' + _("Scatter plot") + '</option>'+
                            '<option value="steps">' + _("Steps") + '</option>'+
                            '<!--<option value="pie">' + _("Pie") + '</option>-->'+
                        '</select></td>'+
                        '<td style="padding-left:5px"><input data-option="color"  style="width:  70px"  class="inputData_color options_lines" value="' + index.color + '"></td>' +
                        '<td style="padding-left:5px"><input data-option="min"  style="width:  70px"  class="inputData_min   options_lines"   value="' + index.min + '"></td>' +
                        '<td style="padding-left:5px"><input data-option="max"  style="width:  70px"  class="inputData_max   options_lines"   value="' + index.max + '"></td>' +
                        '<td style="padding-left:5px"><input data-option="unit"  style="width:  70px"  class="inputData_unit  options_lines"  value="' + index.unit + '"></td>' +
                        '<td style="padding-left:5px">' +
                        '<select style="width:  140px" data-option="yaxe" class="input options_lines">' +
                            '<option value="off">' + _("off") + '</option>' +
                            '<option value="left">' + _("left") + '</option>' +
                            '<option value="right">' + _("right") + '</option>' +
                            '<option value="leftColor">' + _("left colored") + '</option>' +
                            '<option value="rightColor">' + _("right colored") + '</option>' +
                        '</select></td>' +
                        '<td style="padding-left:5px">' +
                        '<select style="width:  140px" data-option="xaxe" class="input options_lines">' +
                            '<option value="off">' + _("off") + '</option>' +
                            '<option value="top">' + _("top") + '</option>' +
                            '<option value="bottom">' + _("bottom") + '</option>' +
                            '<option value="topColor">' + _("top colored") + '</option>' +
                            '<option value="bottomColor">' + _("bottom colored") + '</option>' +
                        '</select></td>' +
                        '<td style="padding-left:5px"><input data-option="thickness" class="inputData_thickness options_lines"  style="width: 30px"   value="' + index.thickness + '"></td>' +
                        '<td style="padding-left:5px"><input data-option="name" class="inputData_name options_lines"       style="width: 200px"  value="' + index.name + '"></td>' +
                        '<td style="padding-left:5px"><button class="idRemove"></button></td>' +
                        '</tr>'

            }

            $('#idslist').html(text);

//            $('.idsnames').change(function () {
//                var id = $(this).attr('id').substring('ids_'.length);
//                ids[id] = $(this).val();
//                update();
//            }).keyup(function () {
//                $(this).trigger('change');
//            });

            $('.inputData_color').colorPicker({
                renderCallback: function ($elm, toggled) {
                    if (toggled === false) {
                        $elm.trigger("change")
                    }
                }
            })


            $('.idRemove').button({
                icons: {primary: 'ui-icon-trash'},
                text: false
            }).click(function () {
                if (setup.options.lines.length > 1) {
                    var i = parseInt($(this).parent().parent().attr("id").replace("inputData", ''));
                    setup.options.lines.splice(i, 1)
                    showIds()
                }
            }).css({width: 22, height: 22});


            $('.select-dialog').button({
                text: false,
                icons: {
                    primary: 'ui-icon-folder-open'
                }
            }).css({width: 25, height: 22}).click(function () {
                var index = $(this).parent().parent().attr('id').replace('inputData', '');
                $('#dialog-select-member').selectId('show', setup.options.lines[index]['id'], undefined, function (newId) {
                    setup.options.lines[index]['id'] = newId;
                    showIds()
                });

            });

            $('.options_lines').each(function () {
                var $this = $(this);
                var index = $(this).parent().parent().attr('id').replace('inputData','');
                var opt = $(this).data('option')
                if (setup.options.lines[index][opt] !== undefined) {
                    if ($this.attr('type') == 'checkbox') {
                        $this.prop('checked', !!setup.options.lines[index][opt]);
                    } else {
                        $this.val(setup.options.lines[index][opt]);
                    }
                }
            })

            if (typeof callback == 'function') callback();
//            update()
        }, 100);
    }

    function getSettings() {
//        var config = {
//            //colors:   ["#c05020", "#30c020", "#6060c0"],
//            //names:    ["Temperature", "Humidity", "Airpressure"],
//        };
//        $('.value').each(function (index) {
//            if ($(this).attr('type') == 'checkbox') {
//                config[$(this).attr('id')] = $(this).prop('checked');
//            } else {
//                config[$(this).attr('id')] = encodeURI($(this).val());
//            }
//        });
//        config._ids = encodeURI(ids.join(';'));
//        config._offsets = encodeURI(offsets.join(';'));
//        config._arts = encodeURI(arts.join(';'));
//        config._colors = encodeURI(colors.join(';'));
////        config._names = encodeURI(names.join(';'));
//
//        var config =  jQuery.param(setup.options)
//console.log()
//        var text = '';
//        for (var opt in config) {
//            if (config[opt]) text += (text ? '&' : '') + opt + '=' + config[opt];
//
//        }
//
//        var x = decodeURIComponent(jQuery.param(setup.options);
//        console.log()


        var _options = JSON.parse(JSON.stringify(setup.options));

        // clean options
        for (var x in _options){
            if(_options[x] == ''){
                delete _options[x]
            }
        }


        // clean linse
        for (var i=0; i < _options.lines.length; i++) {
            if (_options.lines[i].id == ''){
                _options.lines.splice(i,1)
                i--
            }else{
                for (var x in _options.lines[i]) {
                    if (_options.lines[i][x] == '') {
                        delete _options.lines[i][x]
                    }
                }
            }


        }

        var params = $.param(_options);
        console.log(deparam(params))
        return  params
    }

    function delayedUpdate() {
        if (timer) {
            clearTimeout(timer);
            timer = null;
        }
        timer = setTimeout(update, 500);
    }

    function update() {
        clearTimeout(timer);
        timer = null;
        var settings = getSettings();
        $('#link').val(location.href.replace('edit.html', 'index.html') + '?' + settings);
        $('#updatePreview').button("option", "disabled", false).click(function(){

        });
        // Store settings
        if (typeof(Storage) !== "undefined") {

            $('.value').each(function (index) {
                if ($(this).attr('type') == 'checkbox') {
                    setup[$(this).attr('id')] = $(this).prop('checked');
                } else {
                    setup[$(this).attr('id')] = $(this).val();
                }
            });
            $('.option').each(function (index) {
                if ($(this).attr('type') == 'checkbox') {
                    setup.options[$(this).attr('id')] = $(this).prop('checked');
                } else {
                    setup.options[$(this).attr('id')] = $(this).val();
                }
            });

            save()
        }

        if ($('#aggregateType').val() == "step") {
            $('#spanName').text(_("Seconds") + ":")
        } else {
            $('#spanName').text(_("Counts") + ":")
        }
        $('.relative, .static').hide()
        $('.' + $('#timeArt').val()).show()
    }

    function save(){
        localStorage.setItem("iobroker.Flot", JSON.stringify(setup));
    }

    function updatePreview() {
        $('#chart').css({height: (parseInt($('#height').val()) || 500) + 90});
        var settings = getSettings();
        $('#chart').attr('src', '');
        setTimeout(function () {
            $('#chart').attr('src', 'index.html?' + settings + '&' + (new Date()).getTime());
        }, 0);

//        $('#updatePreview').button("option", "disabled", true);
    }

    $(document).ready(function() {

        if (typeof(Storage) !== "undefined") {
            var _setup = localStorage.getItem("iobroker.Flot");
            try {
                _setup = JSON.parse(_setup);
                if (_setup.options){
                    setup = _setup
                }
            }
            catch (e) {
                console.log('Cannot parse stored settings');
            }
        }

        $("#accordion").on('change', '.options_lines', function(){
            var index = parseInt($(this).parent().parent().attr('id').replace('inputData',''));
            setup.options.lines[index][$(this).data('option')] = $(this).val();
            update()
        });

        $('.value').each(function () {
            var $this = $(this);
            var id = $this.attr('id');
            if (setup[id] !== undefined) {
                if ($this.attr('type') == 'checkbox') {
                    $this.prop('checked', !!setup[id]);
                } else {
                    $this.val(setup[id]);
                }
            }
        });

        $('.option').each(function () {
            var $this = $(this);
            var id = $this.attr('id');
            if (setup.options[id] !== undefined) {
                if ($this.attr('type') == 'checkbox') {
                    $this.prop('checked', !!setup.options[id]);
                } else {
                    $this.val(setup.options[id]);
                }
            }
        });

        $('#ids_add').button({
            icons: {secondary: 'ui-icon-plus'},
            text: true
        }).click(function () {

            var index = setup.options.lines.length;
            setup.options.lines.push({
                id:     '',
                offset: 0,
                art:    'average',
                color:  defaultColors[index] || '#00FFFF',
                min:    '',
                max:    '',
                thickness: 3,
                unit:   '',
                name:   ''
            });

            showIds()
        }).css({width: 165, height: 30});

        $('#clear').button({
            icons: {primary: 'ui-icon-trash'},
            text: false
        }).click(function () {
            localStorage.setItem('iobroker.Flot', JSON.stringify({reset: true}));
            location.reload();
        }).css({width: 30, height: 30});

        $('.value').change(update).keyup(function () {
            $(this).trigger('change');
        });
        $('.option').change(update).keyup(function () {
            $(this).trigger('change');
        });

        $('#timeArt').change(function () {
            $('.relative, .static').hide();
            $('.' + $(this).val()).show();
        });

        $('#width').spinner().on('spin', delayedUpdate).parent().addClass('input');
        $('#height').spinner().on('spin', delayedUpdate).parent().addClass('input');
        $('#smoothing').spinner().on('spin', delayedUpdate).parent().addClass('input');
        $('#strokeWidth').spinner().on('spin', delayedUpdate).parent().addClass('input');
        $('#afterComma').spinner().on('spin', delayedUpdate).parent().addClass('input');


        $('#aggregateType').change(function () {
            if ($('#aggregateType').val() == 'step') {
                $('#spanName').text(_('Seconds'))
            } else {
                $('#spanName').text(_('Counts'))
            }
        });


//      $('#range').val(options.range);
//      $('#axeX').val(options.axeX);
        $('#updatePreview').button();
        $('#open').button().click(function () {
            window.open($('#link').val());
        });

        translateAll();

        $('#accordion').accordion({
            active : parseInt(setup.acc) || 0,
            heightStyle: 'fill',
            animate: {
                easing: 'linear',
                duration: 200
            },
            activate: function (event, ui) {
                setup['acc'] = $(ui.newHeader).attr('id');
                save();
            }
        });

        showIds();

        update();
        // Handler for .ready() called.
    });

</script>
</body>
</html>